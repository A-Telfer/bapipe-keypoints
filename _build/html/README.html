
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Behaviour Analysis for Keypoint Data &#8212; Behavioural Analysis Pipeline for Keypoints Data</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Behavioural Analysis Pipeline for Keypoints Data</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="docs/intro.html">
   Behavior Analysis for Keypoints Pipeline
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="docs/paper-structure.html">
   Paper
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="docs/markdown.html">
   Markdown Files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="docs/notebooks.html">
   Content with notebooks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="docs/markdown-notebooks.html">
   Notebooks with MyST Markdown
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/README.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/A-Telfer/bapipe-keypoints"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/A-Telfer/bapipe-keypoints/issues/new?title=Issue%20on%20page%20%2FREADME.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#background">
   Background
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#installation">
   Installation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dockerfiles">
   Dockerfiles
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#structure-of-data">
   Structure of Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-experiment">
   Load Experiment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compare-original-videos-to-corrected-videos">
   Compare original videos to corrected videos
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analysis-examples">
   Analysis Examples
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-1-video-validation">
     Example 1: Video Validation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-2-distance-travelled">
     Example 2: Distance Travelled
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-2-heatmaps">
     Example 2: Heatmaps
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#find-position-density">
       Find position density
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#create-contour-plots">
       Create contour plots
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-3-zone-based-analysis">
     Example 3: Zone based analysis
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Behaviour Analysis for Keypoint Data</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#background">
   Background
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#installation">
   Installation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dockerfiles">
   Dockerfiles
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#structure-of-data">
   Structure of Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-experiment">
   Load Experiment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compare-original-videos-to-corrected-videos">
   Compare original videos to corrected videos
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analysis-examples">
   Analysis Examples
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-1-video-validation">
     Example 1: Video Validation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-2-distance-travelled">
     Example 2: Distance Travelled
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-2-heatmaps">
     Example 2: Heatmaps
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#find-position-density">
       Find position density
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#create-contour-plots">
       Create contour plots
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-3-zone-based-analysis">
     Example 3: Zone based analysis
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="behaviour-analysis-for-keypoint-data">
<h1>Behaviour Analysis for Keypoint Data<a class="headerlink" href="#behaviour-analysis-for-keypoint-data" title="Permalink to this headline">¶</a></h1>
<p>A pipeline for processing behavioural keypoint data gathered from deep learning models (we used DeepLabCut). Demonstrates a few common data/figures for posters/publications.</p>
<p>Author: Andre Telfer (<a class="reference external" href="mailto:andretelfer&#37;&#52;&#48;cmail&#46;carleton&#46;ca">andretelfer<span>&#64;</span>cmail<span>&#46;</span>carleton<span>&#46;</span>ca</a>) / happy to answer questions / open to collaboration<br />
Affiliation: Abizaid Lab (Dr. Alfonso Abizaid), Carleton University, Canada</p>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>Advances in Deep Learning have driven a wave of pose-estimation tools which extract information from animals and their surroundings (<a class="reference external" href="http://www.mackenziemathislab.org/deeplabcut">DeepLabCut</a>, <a class="reference external" href="https://github.com/CMU-Perceptual-Computing-Lab/openpose">OpenPose</a>, <a class="reference external" href="https://sleap.ai/">SLEAP</a>). These models are trained to extract keypoint data (x, y coordinates) for specified bodyparts or objects in the environment.</p>
<p>This pipeline automates a number of steps involved in turning this keypoint data from behavioural experiments into meaningful data and visuallizations. Some of these steps include</p>
<ul class="simple">
<li><p>Aligning videos to account for changes in camera perspective</p></li>
<li><p>Several outlier-filtering strategies</p></li>
<li><p>Creating videos and other validation graphs</p></li>
<li><p>Trimming video duration for when the mouse is first visible</p></li>
</ul>
<p>We demonstrate a few examples of using DeepLabCut data in order to produce</p>
<ol class="simple">
<li><p>Custom validation videos</p></li>
<li><p>Total distance travelled by treatment group</p></li>
<li><p>Heatmaps by treatment group treatment groups</p></li>
<li><p>Time spent in a zone</p></li>
</ol>
<p>Entire experiments can often be processed quite quickly at this level, so this pipeline enables the ability to evaluate experiments for multiple parameters (e.g. different zone sizes) and develop real time dashboards for analysis. Furthermore, it includes an image registration step that removes scale and position variance between videos, allowing for perfectly aligned analysis not available in existing commercial or open source tools.</p>
<p><img alt="" src="docs/assets/rt-dashboard-demo.gif" />
Real-time dashboard example developed to explore the results of an experiment.</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="o">-</span><span class="n">q</span> <span class="n">bapipe</span><span class="o">-</span><span class="n">keypoints</span><span class="o">-</span><span class="n">telfer</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
<p>To install the local code</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">deps</span> <span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">reinstall</span> <span class="o">..</span>
</pre></div>
</div>
</div>
<div class="section" id="dockerfiles">
<h2>Dockerfiles<a class="headerlink" href="#dockerfiles" title="Permalink to this headline">¶</a></h2>
<p>For convenience, we also provide dockerfiles to replicate our analysis environment</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone git@github.com:A-Telfer/bapipe-keypoints.git
<span class="nb">cd</span> bapipe-keypoints
bash docker-run.sh
</pre></div>
</div>
</div>
<div class="section" id="structure-of-data">
<h2>Structure of Data<a class="headerlink" href="#structure-of-data" title="Permalink to this headline">¶</a></h2>
<p>In order to use this pipeline, load a csv file with the following information</p>
<ul class="simple">
<li><p>subject id</p></li>
<li><p>path to video</p></li>
<li><p>path to mouse bodypart position files (expects a deeplabcut-style .h5 file)</p></li>
<li><p>path to video landmarks (e.g. box corners) [optional but required for alignment]. Expects arena corners to be named “top_left”, “top_right”, “bottom_right”, “bottom_left”. Alternatively modify the <code class="docutils literal notranslate"><span class="pre">Video.get_perspective_transform</span></code> function.</p></li>
<li><p>path to camera calibrations [optional but required to remove lens warping]. See docs for more details of how to get the transform. Camera calibrations file is a json with two fields.</p></li>
</ul>
<p>Expected camera calibrations format:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;camera_matrix&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="mf">565.8324795610855</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">487.1592322950171</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">571.836529795452</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">262.8933681996104</span><span class="w"></span>
<span class="w">        </span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">0.0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">1.0</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;distortion_coefficients&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"></span>
<span class="w">            </span><span class="mf">-0.3713229469534476</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">0.21375246276219506</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">0.003855922357321911</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">-0.001019997660503782</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="mf">-0.07011686555555051</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;mean_error&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0467415172925615</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="n">PROJECT</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/jovyan/shared/shared/curated/fran/v2&quot;</span><span class="p">)</span>

<span class="n">datafiles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">PROJECT</span> <span class="o">/</span> <span class="s1">&#39;datafiles.csv&#39;</span><span class="p">)</span>
<span class="n">datafiles</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU times: user 378 ms, sys: 1.03 s, total: 1.41 s
Wall time: 210 ms
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>video</th>
      <th>mouse_labels</th>
      <th>landmark_labels</th>
      <th>camera_calibrations</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>m1</td>
      <td>videos/m1.mp4</td>
      <td>videos/mouse_labels/m1DLC_resnet50_agrpNov19sh... .h5</td>
      <td>videos/landmark_labels/m1DLC_resnet50_agrp_lan... .h5</td>
      <td>camera_calibrations.json</td>
    </tr>
    <tr>
      <th>1</th>
      <td>m2</td>
      <td>videos/m2.mp4</td>
      <td>videos/mouse_labels/m2DLC_resnet50_agrpNov19sh... .h5</td>
      <td>videos/landmark_labels/m2DLC_resnet50_agrp_lan... .h5</td>
      <td>camera_calibrations.json</td>
    </tr>
    <tr>
      <th>2</th>
      <td>m3</td>
      <td>videos/m3.mp4</td>
      <td>videos/mouse_labels/m3DLC_resnet50_agrpNov19sh... .h5</td>
      <td>videos/landmark_labels/m3DLC_resnet50_agrp_lan... .h5</td>
      <td>camera_calibrations.json</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="section" id="load-experiment">
<h2>Load Experiment<a class="headerlink" href="#load-experiment" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Normalize videos</p>
<ul>
<li><p>Register arena corners</p></li>
<li><p>Remove lens warping</p></li>
<li><p>Clip start time for when mouse is first visible</p></li>
</ul>
</li>
<li><p>Outlier correction</p>
<ul>
<li><p>Remove based on pairwise distances</p></li>
<li><p>Remove based on bodypart velocities</p></li>
</ul>
</li>
<li><p>Provide an api for common operations</p>
<ul>
<li><p>Parallelized analysis to reduce run times by several times</p></li>
<li><p>Provides visibility for common features</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span> 
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">bapipe</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">bapipe</span><span class="o">.</span><span class="n">AnalysisConfig</span><span class="p">(</span>
    <span class="n">box_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>            <span class="c1"># size of the box in mm (or any other units)</span>
    <span class="n">remove_lens_distortion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>     <span class="c1"># remove distortion caused by camera lens (requires a calibration file)</span>
    <span class="n">use_box_reference</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>          <span class="c1"># align all of the videos for the test arena</span>
<span class="p">)</span>

<span class="n">video_set</span> <span class="o">=</span> <span class="n">bapipe</span><span class="o">.</span><span class="n">VideoSet</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafiles</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="n">PROJECT</span><span class="p">)</span>
<span class="n">video_set</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>100%|████████████████████████████████████████████████████████| 72/72 [00:09&lt;00:00,  7.63it/s]


CPU times: user 1.83 s, sys: 737 ms, total: 2.57 s
Wall time: 10.1 s
</pre></div>
</div>
<table><tr><td>Number of videos</td><td>72</td></tr><tr><td>Video sizes (W,H)</td><td>960x540</td></tr><tr><td>Total duration [s]</td><td>47837.6</td></tr><tr><td>Average duration [s]</td><td>664.41</td></tr></table>
</div>
<div class="section" id="compare-original-videos-to-corrected-videos">
<h2>Compare original videos to corrected videos<a class="headerlink" href="#compare-original-videos-to-corrected-videos" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="mi">52</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span>
<span class="n">override_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;use_box_reference&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;remove_lens_distortion&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bapipe</span><span class="o">.</span><span class="n">create_video_grid</span><span class="p">(</span><span class="n">video_set</span><span class="p">,</span> <span class="n">override_config</span><span class="o">=</span><span class="n">override_config</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">60</span><span class="p">:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Aligned&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bapipe</span><span class="o">.</span><span class="n">create_video_grid</span><span class="p">(</span><span class="n">video_set</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="png" src="docs/assets/output_9_0.png" /></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU times: user 45.3 s, sys: 5.51 s, total: 50.9 s
Wall time: 8.9 s
</pre></div>
</div>
</div>
<div class="section" id="analysis-examples">
<h2>Analysis Examples<a class="headerlink" href="#analysis-examples" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">treatment_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">PROJECT</span> <span class="o">/</span> <span class="s1">&#39;cohorts1&amp;2.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;animal&#39;</span><span class="p">)</span>
<span class="n">treatment_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU times: user 3.49 ms, sys: 0 ns, total: 3.49 ms
Wall time: 2.65 ms
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>injected_on</th>
      <th>injected_with</th>
      <th>amount_eaten</th>
      <th>treatment1</th>
      <th>treatment2</th>
      <th>cohort</th>
      <th>latency_to_approach</th>
      <th>time_in_corner</th>
      <th>time_eating</th>
      <th>sex</th>
    </tr>
    <tr>
      <th>animal</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>m1</th>
      <td>2021-07-16</td>
      <td>saline/saline</td>
      <td>0.0</td>
      <td>saline</td>
      <td>saline</td>
      <td>1</td>
      <td>6.18</td>
      <td>245.17</td>
      <td>16.15</td>
      <td>male</td>
    </tr>
    <tr>
      <th>m2</th>
      <td>2021-07-15</td>
      <td>saline/ghrelin</td>
      <td>0.2</td>
      <td>saline</td>
      <td>ghrelin</td>
      <td>1</td>
      <td>22.97</td>
      <td>124.21</td>
      <td>35.81</td>
      <td>male</td>
    </tr>
    <tr>
      <th>m3</th>
      <td>2021-07-15</td>
      <td>mt2/ghrelin</td>
      <td>0.1</td>
      <td>mt2</td>
      <td>ghrelin</td>
      <td>1</td>
      <td>10.39</td>
      <td>130.09</td>
      <td>11.01</td>
      <td>male</td>
    </tr>
  </tbody>
</table>
</div>
<div class="section" id="example-1-video-validation">
<h3>Example 1: Video Validation<a class="headerlink" href="#example-1-video-validation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Annotate what&#39;s being scored over the videos
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Video</span>

<span class="n">video</span> <span class="o">=</span> <span class="n">video_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">with</span> <span class="n">bapipe</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="s1">&#39;test.mp4&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1100</span><span class="p">)):</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">bapipe</span><span class="o">.</span><span class="n">draw_dataframe_points</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">mouse_df</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

<span class="n">Video</span><span class="p">(</span><span class="s1">&#39;test.mp4&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>100%|██████████████████████████████████████████████████████| 100/100 [00:04&lt;00:00, 22.82it/s]

CPU times: user 24.6 s, sys: 3.22 s, total: 27.8 s
Wall time: 4.46 s
</pre></div>
</div>
<video src="docs/assets/test.mp4" controls  >
      Your browser does not support the <code>video</code> element.
    </video>
</div>
<div class="section" id="example-2-distance-travelled">
<h3>Example 2: Distance Travelled<a class="headerlink" href="#example-2-distance-travelled" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="k">def</span> <span class="nf">get_distance_travelled</span><span class="p">(</span><span class="n">video</span><span class="p">):</span>
    <span class="c1"># Average the bodypart positions of the mouse to get its centroid </span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">mouse_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;coords&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Get the between-frame movement of the bodyparts</span>
    <span class="n">deltas</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="c1"># Calculate the total distance travelled </span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">deltas</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">distances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">video_set</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_distance_travelled</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="n">video_set</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">treatment_data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">distances</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;injected_with&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Treatment Group&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Distance Travelled [mm]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Locomotivity: Distance Travelled&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>100%|███████████████████████████████████████████████████████| 72/72 [00:00&lt;00:00, 216.58it/s]
</pre></div>
</div>
<p><img alt="png" src="docs/assets/output_15_1.png" /></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU times: user 439 ms, sys: 977 ms, total: 1.42 s
Wall time: 660 ms
</pre></div>
</div>
</div>
<div class="section" id="example-2-heatmaps">
<h3>Example 2: Heatmaps<a class="headerlink" href="#example-2-heatmaps" title="Permalink to this headline">¶</a></h3>
<p>Show what zones the mice are spending their time</p>
<div class="section" id="find-position-density">
<h4>Find position density<a class="headerlink" href="#find-position-density" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span> 
<span class="kn">from</span> <span class="nn">scipy.stats.kde</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>

<span class="n">groups</span> <span class="o">=</span> <span class="n">treatment_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;treatment1&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment2&#39;</span><span class="p">])</span>
<span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">box_shape</span>

<span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
    <span class="n">group_videos</span> <span class="o">=</span> <span class="p">[</span><span class="n">video_set</span><span class="p">[</span><span class="n">video_set</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    
    <span class="c1"># Stack the mouse-location dataframes for each mouse in this treatment group</span>
    <span class="n">group_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">video</span><span class="o">.</span><span class="n">mouse_df</span> <span class="k">for</span> <span class="n">video</span> <span class="ow">in</span> <span class="n">group_videos</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="c1"># Get the centroid of the mouse by averaging the bodypart positions in each frame</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">group_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;coords&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">[[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>
    
    <span class="c1"># Get the density of time spent in location (down sampled for 1 frame every 100)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data</span><span class="p">[:,::</span><span class="mi">100</span><span class="p">],</span> <span class="p">)</span>
    <span class="n">mgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">h</span><span class="p">,</span> <span class="p">:</span><span class="n">w</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">k</span><span class="p">(</span><span class="n">mgrid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">z</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;timed exec&gt;:2: DeprecationWarning: Please use `gaussian_kde` from the `scipy.stats` namespace, the `scipy.stats.kde` namespace is deprecated.
100%|██████████████████████████████████████████████████████████| 4/4 [00:11&lt;00:00,  2.86s/it]

CPU times: user 12.3 s, sys: 4.22 s, total: 16.5 s
Wall time: 11.4 s
</pre></div>
</div>
</div>
<div class="section" id="create-contour-plots">
<h4>Create contour plots<a class="headerlink" href="#create-contour-plots" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">CONTOUR_LEVELS</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">video</span> <span class="o">=</span> <span class="n">video_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Box Reference&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">gname</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">gname</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="c1"># plotting a frame sets up the matplotlib axis correctly</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mgrid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mgrid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">CONTOUR_LEVELS</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU times: user 589 ms, sys: 50 ms, total: 639 ms
Wall time: 178 ms
</pre></div>
</div>
<p><img alt="png" src="docs/assets/output_20_1.png" /></p>
</div>
</div>
<div class="section" id="example-3-zone-based-analysis">
<h3>Example 3: Zone based analysis<a class="headerlink" href="#example-3-zone-based-analysis" title="Permalink to this headline">¶</a></h3>
<p>Zones on can be drawn once in tools like napari, or automatically plotted</p>
<p>If the videos have been normalized, zones can be drawn once and applied to all videos</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="k">def</span> <span class="nf">get_center_zone</span><span class="p">(</span><span class="n">video</span><span class="p">):</span>
    <span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">video_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">box_shape</span>
    <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span>
        <span class="p">[</span><span class="n">cx</span><span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="n">cy</span><span class="o">-</span><span class="n">s</span><span class="p">],</span>
        <span class="p">[</span><span class="n">cx</span><span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="n">cy</span><span class="o">+</span><span class="n">s</span><span class="p">],</span>
        <span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="n">s</span><span class="p">,</span> <span class="n">cy</span><span class="o">+</span><span class="n">s</span><span class="p">],</span>
        <span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="n">s</span><span class="p">,</span> <span class="n">cy</span><span class="o">-</span><span class="n">s</span><span class="p">]</span>
    <span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Center zone&#39;</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">time_in_zone</span><span class="p">(</span><span class="n">video</span><span class="p">):</span>
    <span class="n">center_zone</span> <span class="o">=</span> <span class="n">get_center_zone</span><span class="p">(</span><span class="n">video</span><span class="p">)</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">mouse_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;coords&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">center_zone</span><span class="o">.</span><span class="n">contains_points</span><span class="p">(</span><span class="n">centroid</span><span class="p">))</span> <span class="o">/</span> <span class="n">video</span><span class="o">.</span><span class="n">fps</span>


<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">video_set</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">time_in_zone</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="n">video_set</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;time_in_center_zone&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">video_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get_frame</span><span class="p">(</span><span class="mi">900</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">get_center_zone</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">treatment_data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;injected_with&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;time_in_center_zone&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Treatment Group&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Time in Zone [s]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time in Zone&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>100%|███████████████████████████████████████████████████████| 72/72 [00:00&lt;00:00, 185.93it/s]


CPU times: user 583 ms, sys: 309 ms, total: 892 ms
Wall time: 682 ms





Text(0.5, 1.0, &#39;Time in Zone&#39;)
</pre></div>
</div>
<p><img alt="png" src="docs/assets/output_22_3.png" /></p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Andre Telfer<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>